"use strict";(self["webpackChunkh990"]=self["webpackChunkh990"]||[]).push([[272],{272:function(e,t,a){a.r(t),a.d(t,{default:function(){return Y}});var l=a(3396),i=a(7139);const s={class:"p-4"},n=(0,l.Uk)(" Upload CSV "),r={class:"py-3"},o={class:"table-page-search-submitButtons",style:{float:"right",overflow:"hidden"}},d=(0,l.Uk)(" 上傳 "),u={class:"py-3"},c={key:0,class:"ms-3"};function p(e,t,a,p,m,h){const f=(0,l.up)("upload-outlined"),_=(0,l.up)("a-button"),y=(0,l.up)("a-upload"),k=(0,l.up)("a-select-option"),w=(0,l.up)("a-select"),b=(0,l.up)("a-form-item"),g=(0,l.up)("a-col"),v=(0,l.up)("a-row"),$=(0,l.up)("a-form"),W=(0,l.up)("a-card"),T=(0,l.up)("a-table-column"),Y=(0,l.up)("a-table"),D=(0,l.up)("a-spin");return(0,l.wg)(),(0,l.iD)("div",s,[(0,l.Wm)(y,{showUploadList:!1,name:"file",customRequest:h.readFile},{default:(0,l.w5)((()=>[(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(f),n])),_:1}),(0,l.Uk)(" "+(0,i.zw)(m.name?m.name:e.$t("noFileSelected")),1)])),_:1},8,["customRequest"]),(0,l._)("div",r,[(0,l.Wm)(W,{size:"small",title:"標題對應名稱"},{default:(0,l.w5)((()=>[(0,l.Wm)($,{ref:"importRef",model:m.list,class:"ant-advanced-search-form"},{default:(0,l.w5)((()=>[(0,l.Wm)(v,{gutter:24},{default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(m.renderTitle,((t,a)=>((0,l.wg)(),(0,l.j4)(g,{key:a,lg:8,md:12,sm:24,xs:24},{default:(0,l.w5)((()=>[(0,l.Wm)(b,{name:t.value,rules:[{required:t.required,message:e.$t("requiredSelectFeedback")}],label:e.$t(t.label)},{default:(0,l.w5)((()=>[(0,l.Wm)(w,{value:m.list[t.value],"onUpdate:value":e=>m.list[t.value]=e,style:{width:"100%"}},{default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(m.importTitle,(e=>((0,l.wg)(),(0,l.j4)(k,{allowClear:"true",key:e,value:e},{default:(0,l.w5)((()=>[(0,l.Uk)((0,i.zw)(e),1)])),_:2},1032,["value"])))),128))])),_:2},1032,["value","onUpdate:value"])])),_:2},1032,["name","rules","label"])])),_:2},1024)))),128)),(0,l.Wm)(g,{lg:8,md:12,sm:24,xs:24},{default:(0,l.w5)((()=>[(0,l.Wm)(b,{rules:[{required:!0,message:e.$t("cardTypeFeedback")}],name:"card_type",label:e.$t("cardType")},{default:(0,l.w5)((()=>[(0,l.Wm)(w,{value:m.list.card_type,"onUpdate:value":t[0]||(t[0]=e=>m.list.card_type=e),style:{width:"100%"},options:[{label:e.$t("一般卡"),value:"81"},{label:e.$t("黑名單發警報"),value:"03"},{label:e.$t("黑名單不發警報"),value:"05"},{label:e.$t("不受Anti管制卡"),value:"88"}]},null,8,["value","options"])])),_:1},8,["rules","label"])])),_:1}),(0,l.Wm)(g,{lg:8,md:12,sm:24,xs:24},{default:(0,l.w5)((()=>[(0,l.Wm)(b,{label:e.$t("comparisonMode")},{default:(0,l.w5)((()=>[(0,l.Wm)(w,{value:m.list.authentication_type,"onUpdate:value":t[1]||(t[1]=e=>m.list.authentication_type=e),style:{width:"100%"},options:[{value:0,label:e.$t("swipeCard")},{value:1,label:e.$t("swipeCard")+" & "+e.$t("photograph")}]},null,8,["value","options"])])),_:1},8,["label"])])),_:1}),(0,l.Wm)(g,{lg:24,md:24,sm:24,xs:24},{default:(0,l.w5)((()=>[(0,l._)("span",o,[(0,l.Wm)(_,{disabled:m.data&&0===m.data.length,onClick:h.onCheck,type:"primary",style:{"margin-left":"8px"}},{default:(0,l.w5)((()=>[d])),_:1},8,["disabled","onClick"]),(0,l.Wm)(_,{onClick:h.reset,style:{"margin-left":"8px"}},{default:(0,l.w5)((()=>[(0,l.Uk)((0,i.zw)(e.$t("reset")),1)])),_:1},8,["onClick"])])])),_:1})])),_:1})])),_:1},8,["model"])])),_:1})]),(0,l.Wm)(D,{spinning:m.spinning,tip:"Loading..."},{default:(0,l.w5)((()=>[(0,l._)("div",u,[(0,l.Wm)(W,{bodyStyle:{padding:0},size:"small",title:"預覽"},{default:(0,l.w5)((()=>[(0,l.Wm)(Y,{size:"small","data-source":m.data,pagination:{size:"middle","show-quick-jumper":!0,defaultPageSize:20,position:["bottomLeft"],pageSizeOptions:["10","20","30","40"],style:{"margin-left":"12px"}}},{bodyCell:(0,l.w5)((({text:e,column:t})=>[0===t.key?((0,l.wg)(),(0,l.iD)("span",c,(0,i.zw)(e),1)):(0,l.kq)("",!0)])),default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(m.importTitle,((e,t)=>((0,l.wg)(),(0,l.j4)(T,{key:t,class:(0,i.C_)([{"ps-4":0===t},"table-bg-primary"]),title:e,"data-index":e,ellipsis:!0},null,8,["class","title","data-index"])))),128))])),_:1},8,["data-source"])])),_:1})])])),_:1},8,["spinning"])])}a(7658);var m={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M400 317.7h73.9V656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V317.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 163a8 8 0 00-12.6 0l-112 141.7c-4.1 5.3-.4 13 6.3 13zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z"}}]},name:"upload",theme:"outlined"},h=m,f=a(9388);function _(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?Object(arguments[t]):{},l=Object.keys(a);"function"===typeof Object.getOwnPropertySymbols&&(l=l.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),l.forEach((function(t){y(e,t,a[t])}))}return e}function y(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}var k=function(e,t){var a=_({},e,t.attrs);return(0,l.Wm)(f.Z,_({},a,{icon:h}),null)};k.displayName="UploadOutlined",k.inheritAttrs=!1;var w=k,b=a(5743),g=a.n(b),v=a(2074),$={components:{UploadOutlined:w},data(){return{spinning:!1,list:{authentication_type:0,card_id:"card_id",card_type:"81",created_since:"created_since",email:"email",holiday_name:"holiday_id",person_id:"person_id",username:"username",valid_till:"valid_till",week_name:"week_id",makeup_name:"makeup_id",password_hash:"password_hash"},name:"",dateFormat:"YYYY-MM-DD HH:mm:ss",finalData:[],data:[],dataString:"",renderTitle:[{label:"name",value:"username",required:!0},{label:"personID",value:"person_id"},{label:"cardID",value:"card_id",required:!0},{label:"email",value:"email",required:!0},{label:"holidayTable",value:"holiday_name"},{label:"weekTable",value:"week_name"},{label:"make-upWorkdayTable",value:"makeup_name"},{label:"startTime",value:"created_since"},{label:"endTime",value:"valid_till"},{label:"password",value:"password_hash"}],importTitle:[],weekList:[],holidayList:[],makeupList:[]}},methods:{dayjs:g(),readFile(e){const t=this,a=e.file;if("text/csv"!==a.type)return void v.ZP.error("請選擇csv檔");const l=new FileReader;t.spinning=!0,t.importTitle=[" "],t.data=[{}],t.name=e.file.name,l.readAsText(a),l.onload=function(){if(l.result.includes("�"))return v.ZP.error("編碼格式錯誤，請上傳 UTF-8 格式文件"),void(t.spinning=!1);const e=l.result.replaceAll("\r\n","\n").replace(/\n[\n]+/g,"\n").replace(/\n$/,"");t.dataString=e,t.importTitle=[];const a=e.split("\n");let i="";const s=[];a.forEach(((e,a)=>{const l=e.split('"').filter((e=>e));let n=[];l.forEach(((t,a)=>{if(1!==l.length)if(","===t[0]){const e=t.split(",");e.shift(),n=n.concat(e)}else if(","===t.substr(-1)){const e=t.split(",");e.pop(),n=n.concat(e)}else n=n.concat(t);else n=e.split(",")})),0===a?n.forEach((e=>{t.importTitle.push(e)})):(i="",n.forEach(((e,a)=>{i+=`"${t.importTitle[a]}":"${e.replaceAll('"',"")}",`})),i=`{${i.slice(0,-1)}}`,s.push(JSON.parse(i)))})),t.data=s,t.finalData=[],t.spinning=!1}},reset(){this.list={},this.$refs.importRef.clearValidate()},preview(){this.spinning=!0;const e=this.dataString.split("\r\n"),t={},a=this.list.card_type||null,l=0===this.list.authentication_type?0:this.list.authentication_type||null,i={...this.list},s=[];let n="",r=[];e.forEach(((e,a)=>{const l=e.split(",");if(0===a)return r=l,r.forEach((e=>{t[e]=[]})),!1;for(let i=0;i<r.length-1;i++)t[r[i]].push(l[i])}));for(let o=0;o<e.length-1;o++){n="";for(const e in i)switch(e){case"created_since":n+=`"${e}":"${g()(t[i[e]][o]).format("YYYY-MM-DDTHH:mm:ss.000001")}",`;break;case"valid_till":n+=`"${e}":"${g()(t[i[e]][o]).format("YYYY-MM-DDTHH:mm:ss.999999")}",`;break;case"card_type":break;case"authentication_type":break;default:n+=`"${e}":"${t[i[e]][o]}",`;break}n+=`"authentication_type":${l},"card_type":${a}`,n=`{${n}}`,s.push(JSON.parse(n))}this.finalData=s,this.spinning=!1},onCheck(){this.$refs.importRef.validateFields().then((e=>{this.upload()})).catch((()=>{this.$refs.importRef.scrollToField()}))},upload(){const e=this.dataString.split("\n"),t={},a=this.list.card_type||null,l=0===this.list.authentication_type?0:this.list.authentication_type||null,i={...this.list},s=[];let n="",r=[];e.forEach(((e,a)=>{const l=e.split('"').filter((e=>e));let i=[];if(l.forEach(((t,a)=>{if(1!==l.length)if(","===t[0]){const e=t.split(",");e.shift(),i=i.concat(e)}else if(","===t.substr(-1)){const e=t.split(",");e.pop(),i=i.concat(e)}else i=i.concat(t);else i=e.split(",")})),0===a)return r=i,r.forEach((e=>{t[e]=[]})),!1;for(let s=0;s<r.length;s++)t[r[s]].push(i[s])}));for(let o=0;o<e.length-1;o++){n="";for(const e in i)switch(e){case"created_since":n+=`"${e}":"${g()(t[i[e]][o]).format("YYYY-MM-DDTHH:mm:ss.000001")}",`;break;case"valid_till":n+=`"${e}":"${g()(t[i[e]][o]).format("YYYY-MM-DDTHH:mm:ss.999999")}",`;break;case"password_hash":t[i[e]][o]&&(n+=`"${e}":"${t[i[e]][o]}",`);break;case"authentication_type":break;case"card_type":break;case"week_name":{const a=this.weekList.find((a=>a.week_name===t[i[e]][o]));n+='"week_id":',n+=a?`"${a.week_id}",`:'"0",';break}case"holiday_name":{const a=this.holidayList.find((a=>a.holiday_name===t[i[e]][o]));n+='"holiday_id":',n+=a?`"${a.holiday_id}",`:'"0",';break}case"makeup_name":{const a=this.makeupList.find((a=>a.makeup_name===t[i[e]][o]));n+='"makeup_id":',n+=a?`"${a.makeup_id}",`:'"0",';break}default:n+=`"${e}":"${t[i[e]][o]}",`;break}n+=`"authentication_type":${l},"card_type":"${a}"`,n=`{${n}}`,s.push(JSON.parse(n))}console.log(s)},getWeekList(){const e="onduty";return this.$http.get(e)},getHoliday(){const e="holiday";return this.$http.get(e)},getMakeupday(){const e="makeup";return this.$http.get(e)}},created(){Promise.all([this.getWeekList(),this.getHoliday(),this.getMakeupday()]).then((([{data:e},{data:t},{data:a}])=>{this.weekList=e.on_dutiess,this.weekList.push({week_id:0,week_name:"不檢查"}),this.holidayList=t.holidays,this.holidayList.push({holiday_id:0,holiday_name:"不檢查"}),this.makeupList=a.makeups,this.makeupList.push({makeup_id:0,makeup_name:"不檢查"})})).catch((e=>e))}},W=a(89);const T=(0,W.Z)($,[["render",p]]);var Y=T}}]);